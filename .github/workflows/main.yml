name: Ubuntu / Mac - c++

on:
  push:
    branches: [master, 23.04-beta]
  pull_request:

  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            tests: unit_test
            access: col_major
            build_type: Release
            protos: OFF
          - os: ubuntu-20.04
            tests: unit_test
            access: col_major
            build_type: Release
            protos: ON
          - os: ubuntu-20.04
            tests: unit_test
            access: row_major
            build_type: Release
            protos: OFF
          - os: ubuntu-20.04
            tests: clang_tidy
            access: col_major
            build_type: Release
            protos: OFF
          - os: macos-11
            tests: unit_test
            access: col_major
            build_type: Release
            protos: OFF
      fail-fast: false
    env:
      BUILD_TYPE: ${{ matrix.build_type }}
      ROW_MAJOR_DEFAULT: OFF
      BUILD_PROTOS: ${{ matrix.protos }}


    steps:
      - uses: actions/checkout@v3
        with:
          submodules: "recursive"

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1

      - name: Install dependencies (Ubuntu)
        run: ./scripts/install_deps_ubuntu.sh
        if: matrix.os == 'ubuntu-20.04' && matrix.access == 'col_major'

      - name: Install dependencies (Ubuntu, Eigen row-major)
        run: ./scripts/install_deps_ubuntu.sh
        env:
          ROW_MAJOR_DEFAULT: ON
        if: matrix.os == 'ubuntu-20.04' && matrix.access == 'row_major'

      - name: Install dependencies (Mac)
        run: ./scripts/install_deps_mac.sh
        if: matrix.os == 'macos-11'

      - name: Run tests
        run:
          ./scripts/run_cpp_tests.sh
        if: matrix.tests == 'unit_test'

      - name: clang-tidy
        run: |
          ./run_clang_tidy.sh
        if: matrix.tests == 'clang_tidy'
